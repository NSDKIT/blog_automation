# キーワード選択機能

## 機能概要

ユーザーが記事生成前に、関連キーワード100個と各キーワードの検索ボリューム・競合度を確認し、使用するキーワードを選択できる機能です。

---

## 処理フロー

### ステップ1: 記事作成
```
ユーザーが記事作成フォームに入力
↓
「記事を生成」ボタンをクリック
↓
記事レコードを作成（status: "keyword_analysis"）
↓
バックグラウンドでキーワード分析を開始
```

### ステップ2: キーワード分析（バックグラウンド）
```
1. OpenAIで関連キーワード100個を生成
   - メインキーワード + 重要キーワード1-3 + サブキーワードから生成
   
2. DataForSEO Keywords Data APIで各キーワードのデータを取得
   - 検索ボリューム
   - 競合度（competition_index: 0-100）
   - CPC（クリック単価）
   
3. スコアリング
   - 検索ボリュームスコア（60%）+ 競合度スコア（40%）
   - 総合スコアでソート
   
4. データベースに保存
   - status: "keyword_selection"（キーワード選択待ち）
   - analyzed_keywords: スコアリング済みキーワード100個（JSONB）
```

### ステップ3: キーワード選択画面
```
ユーザーが記事詳細画面にアクセス
↓
statusが"keyword_selection"の場合、自動でキーワード選択画面にリダイレクト
↓
キーワード選択画面で以下を表示:
  - キーワード一覧（100個）
  - 各キーワードの情報:
    - キーワード名
    - 検索ボリューム
    - 競合度（色分け表示）
    - CPC
    - 総合スコア
  - 検索機能
  - ソート機能（スコア順/検索ボリューム順/競合度順）
  - 全選択/全解除ボタン
↓
ユーザーがキーワードを選択（チェックボックス）
↓
「選択したキーワードで記事生成」ボタンをクリック
```

### ステップ4: 記事生成
```
選択されたキーワードで記事生成を開始
↓
status: "processing"
↓
選択されたキーワードをsecondary_keywordsとして使用
↓
記事生成ワークフローを実行
```

---

## データベーススキーマ

### `articles`テーブルに追加

```sql
ALTER TABLE articles ADD COLUMN IF NOT EXISTS analyzed_keywords JSONB;
ALTER TABLE articles ADD COLUMN IF NOT EXISTS selected_keywords JSONB;
ALTER TABLE articles ADD COLUMN IF NOT EXISTS selected_keywords_data JSONB;
```

### データ形式

#### `analyzed_keywords`（分析済みキーワード）
```json
[
  {
    "keyword": "ブルーライトカットメガネ おすすめ",
    "search_volume": 1200,
    "competition_index": 45,
    "cpc": 120.5,
    "volume_score": 100.0,
    "competition_score": 55.0,
    "total_score": 82.0
  },
  ...
]
```

#### `selected_keywords`（選択されたキーワード）
```json
["キーワード1", "キーワード2", "キーワード3"]
```

#### `selected_keywords_data`（選択されたキーワードの詳細）
```json
[
  {
    "keyword": "キーワード1",
    "search_volume": 1200,
    "competition_index": 45,
    ...
  },
  ...
]
```

---

## APIエンドポイント

### `POST /api/articles/{article_id}/select-keywords`

選択されたキーワードで記事生成を開始

**リクエストボディ**:
```json
{
  "selected_keywords": ["キーワード1", "キーワード2", "キーワード3"]
}
```

**レスポンス**:
```json
{
  "message": "キーワードを選択しました。記事生成を開始します。",
  "selected_keywords": ["キーワード1", "キーワード2", "キーワード3"],
  "selected_count": 3
}
```

---

## フロントエンド

### キーワード選択画面（`/articles/{id}/keywords`）

#### 機能
- **キーワード一覧表示**: 100個のキーワードをテーブル形式で表示
- **検索機能**: キーワード名で検索
- **ソート機能**: 
  - スコア順（デフォルト）
  - 検索ボリューム順
  - 競合度順（低い順）
- **選択機能**: チェックボックスで複数選択
- **全選択/全解除**: ワンクリックで全て選択/解除
- **選択状況表示**: 選択中のキーワード数を表示

#### UI要素
- **テーブル**: キーワード、検索ボリューム、競合度、CPC、スコアを表示
- **競合度の色分け**:
  - 緑: 30未満（低競合）
  - 黄: 30-60（中競合）
  - 赤: 60以上（高競合）
- **スコア表示**: 総合スコアを大きく表示

---

## 記事ステータス

### ステータス一覧

1. **`keyword_analysis`**: キーワード分析中
   - OpenAIでキーワード生成中
   - DataForSEOで検索ボリューム・競合度取得中

2. **`keyword_selection`**: キーワード選択待ち
   - 分析完了、ユーザーの選択を待っている状態

3. **`processing`**: 記事生成中
   - 選択されたキーワードで記事生成中

4. **`completed`**: 完了
   - 記事生成完了

5. **`failed`**: 失敗
   - エラーが発生

---

## 使用例

### 1. 記事作成
```
ユーザーが記事作成フォームに入力:
  - キーワード: "ブルーライトカットメガネ"
  - 重要キーワード1: "PC作業"
  - 重要キーワード2: "眼精疲労"
↓
「記事を生成」をクリック
```

### 2. キーワード分析（自動）
```
バックグラウンドで実行:
  1. OpenAIで100個の関連キーワードを生成
  2. DataForSEOで各キーワードのデータを取得
  3. スコアリング
  4. データベースに保存
```

### 3. キーワード選択
```
ユーザーがキーワード選択画面で:
  - 検索: "PC"でフィルタ
  - ソート: スコア順
  - 選択: 上位10個のキーワードを選択
↓
「選択した10個のキーワードで記事生成」をクリック
```

### 4. 記事生成
```
選択されたキーワードで記事生成を開始
↓
SEO最適化された記事を生成
```

---

## 処理時間

- **キーワード生成（OpenAI）**: 約5-10秒
- **検索ボリューム・競合度取得（DataForSEO）**: 約20-40秒
- **合計**: 約30-60秒

---

## エラーハンドリング

### キーワード生成が失敗した場合
- status: "failed"
- error_message: "キーワード生成に失敗しました"
- ユーザーにエラーを表示

### DataForSEO APIが失敗した場合
- status: "failed"
- error_message: "キーワードデータの取得に失敗しました"
- ユーザーにエラーを表示

### キーワードが選択されなかった場合
- フロントエンドでバリデーション
- 「少なくとも1つのキーワードを選択してください」と表示

---

## 注意事項

1. **APIコスト**: 100個のキーワードを分析するため、1記事あたり約$1-2（約150-300円）のコストがかかります
2. **処理時間**: キーワード分析に約30-60秒かかります
3. **DataForSEOクォータ**: 毎分2000回のAPIコール制限があります
4. **禁止カテゴリ**: 武器、タバコ、ドラッグ等のキーワードは取得できません

---

## 今後の改善案

1. **キーワードのフィルタリング**: 検索ボリュームや競合度で自動フィルタ
2. **推奨キーワード**: スコアが高いキーワードを自動で推奨
3. **キーワードのグループ化**: カテゴリごとにグループ化して表示
4. **履歴機能**: 過去に選択したキーワードを保存

