# 最適なキーワード選定機能

## 機能概要

メインキーワード + 重要キーワード1-3 + サブキーワードから、OpenAIで関連キーワード100個を生成し、DataForSEOで検索ボリューム・競合度を取得して、最適なキーワードを自動選定する機能です。

---

## 処理フロー

### ステップ1: OpenAIで関連キーワード100個を生成

```
入力:
  - メインキーワード
  - 重要キーワード1-3
  - サブキーワード（カンマ区切り）

処理:
  - GPT-4oに「SEO専門家」として関連キーワード100個を生成依頼
  - 検索意図が明確で、記事に自然に組み込めるキーワードを生成
  - 長尾キーワードも含める

出力:
  - 関連キーワード100個のリスト
```

### ステップ2: DataForSEOで検索ボリューム・競合度を取得

```
入力:
  - 生成された100個のキーワード

処理:
  - DataForSEO Keywords Data APIにバッチ送信（最大100個）
  - 各キーワードの以下を取得:
    - 検索ボリューム（月間検索数）
    - 競合度（competition_index: 0-100）
    - CPC（クリック単価）
    - 関連キーワード

出力:
  - 各キーワードのデータ（JSON形式）
```

### ステップ3: スコアリング

```
スコアリング基準:
  - 検索ボリュームスコア（0-100点）:
    - 1000以上: 100点
    - 100-1000: 70-100点（対数スケール）
    - 10-100: 40-70点
    - 0-10: 0-40点
  
  - 競合度スコア（0-100点）:
    - competition_indexが低いほど高スコア
    - スコア = 100 - competition_index
  
  - 総合スコア:
    - (検索ボリュームスコア × 0.6) + (競合度スコア × 0.4)

出力:
  - スコアリング済みキーワードリスト（スコア順）
```

### ステップ4: 最適なキーワードを選定

```
処理:
  - 総合スコアでソート（降順）
  - 上位20個を取得

出力:
  - 最適なキーワード20個（スコア、検索ボリューム、競合度、CPC付き）
```

### ステップ5: 記事生成に活用

```
処理:
  - 最適なキーワードの上位10個をタイトル生成プロンプトに追加
  - 最適なキーワードの上位10個を記事生成プロンプトに追加
  - 記事本文に自然に組み込む

出力:
  - SEO最適化された記事（最適なキーワードを含む）
```

---

## データベース保存

### `articles`テーブルに追加

```sql
ALTER TABLE articles ADD COLUMN IF NOT EXISTS best_keywords JSONB;
```

### 保存データ形式

```json
[
  {
    "keyword": "ブルーライトカットメガネ おすすめ",
    "search_volume": 1200,
    "competition_index": 45,
    "cpc": 120.5,
    "volume_score": 100.0,
    "competition_score": 55.0,
    "total_score": 82.0
  },
  {
    "keyword": "PC作業 眼鏡 選び方",
    "search_volume": 800,
    "competition_index": 30,
    "cpc": 95.0,
    "volume_score": 80.0,
    "competition_score": 70.0,
    "total_score": 76.0
  },
  ...
]
```

---

## フロントエンド表示

### 記事詳細画面

記事詳細画面（`/articles/{id}`）で以下を表示：

- **最適なキーワード（スコアリング済み）**セクション
  - 上位10個のキーワードを表示
  - 各キーワードの情報:
    - キーワード名
    - 検索ボリューム
    - 競合度（0-100）
    - CPC
    - 総合スコア
  - スコアリング基準の説明

---

## スコアリングロジック詳細

### 検索ボリュームスコア

```python
if search_volume >= 1000:
    volume_score = 100
elif search_volume >= 100:
    volume_score = 70 + (search_volume - 100) / 900 * 30
elif search_volume >= 10:
    volume_score = 40 + (search_volume - 10) / 90 * 30
else:
    volume_score = search_volume / 10 * 40
```

### 競合度スコア

```python
competition_score = max(0, 100 - competition_index)
```

### 総合スコア

```python
total_score = (volume_score * 0.6) + (competition_score * 0.4)
```

**重み付けの理由**:
- 検索ボリューム（60%）: 需要の高さを重視
- 競合度（40%）: 獲得しやすさを重視

---

## 使用例

### 入力

- メインキーワード: "ブルーライトカットメガネ"
- 重要キーワード1: "PC作業"
- 重要キーワード2: "眼精疲労"
- 重要キーワード3: "軽量"
- サブキーワード: "ゲーミング, リモートワーク, 長時間作業"

### 処理

1. OpenAIで100個の関連キーワードを生成
   - "ブルーライトカットメガネ おすすめ"
   - "PC作業 眼鏡 選び方"
   - "眼精疲労 対策 メガネ"
   - "軽量 メガネ 長時間"
   - ...（100個）

2. DataForSEOで各キーワードのデータを取得

3. スコアリングして最適な20個を選定

### 出力

記事生成時に最適なキーワードを自動で組み込み、SEO最適化された記事を生成。

---

## エラーハンドリング

### OpenAIキーワード生成が失敗した場合

- エラーログを出力
- **記事生成は続行**（元のキーワードのみで生成）

### DataForSEO APIが失敗した場合

- エラーログを出力
- **記事生成は続行**（元のキーワードのみで生成）

### キーワードが100個未満の場合

- 生成されたキーワードのみで処理
- エラーにはならない

---

## APIコスト

### OpenAI API

- GPT-4o: 約$0.01-0.02/リクエスト（100個のキーワード生成）

### DataForSEO API

- Keywords Data API: 約$0.01-0.02/キーワード
- 100個のキーワード: 約$1-2

### 合計

- **1記事あたり**: 約$1-2（約150-300円）

---

## 注意事項

1. **APIコスト**: 100個のキーワードを分析するため、1記事あたり約150-300円のコストがかかります
2. **処理時間**: 追加で約30-60秒かかります
3. **DataForSEOクォータ**: 毎分2000回のAPIコール制限があります
4. **禁止カテゴリ**: 武器、タバコ、ドラッグ等のキーワードは取得できません

---

## 今後の改善案

1. **キャッシュ機能**: 同じキーワードの分析結果をキャッシュ
2. **バッチ処理**: 複数記事をまとめて処理
3. **スコアリング調整**: ユーザーが重み付けをカスタマイズ可能に
4. **キーワード提案**: 最適なキーワードから記事タイトルを自動提案

