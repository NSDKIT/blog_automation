# データベース（PostgreSQL）の用途

## 概要

このアプリケーションでは、**PostgreSQL**データベースを使用して、アプリケーションのデータを永続的に保存します。

## データベースの用途

### 1. ユーザー管理（users テーブル）

**保存するデータ**:
- ユーザーID
- メールアドレス
- パスワード（ハッシュ化）
- ユーザー名
- ユーザー権限（admin/user）
- 作成日時、更新日時

**用途**:
- ユーザー登録・ログイン機能
- 認証・認可
- ユーザー情報の管理

**例**:
```
ユーザーが「新規登録」→ usersテーブルに保存
ユーザーが「ログイン」→ usersテーブルから認証情報を確認
```

---

### 2. 記事管理（articles テーブル）

**保存するデータ**:
- 記事ID
- ユーザーID（誰が作成したか）
- キーワード
- ターゲット層
- 記事の種類
- 生成されたタイトル
- 生成された記事内容
- Shopify記事ID（投稿済みの場合）
- ステータス（draft/processing/completed/failed）
- 作成日時、更新日時

**用途**:
- 生成された記事の保存
- 記事履歴の管理
- 記事の編集・削除
- 記事の一覧表示

**例**:
```
ユーザーが「記事を生成」→ articlesテーブルに保存
ユーザーが「記事一覧を見る」→ articlesテーブルから取得
ユーザーが「記事を編集」→ articlesテーブルを更新
```

---

### 3. 記事履歴管理（article_histories テーブル）

**保存するデータ**:
- 履歴ID
- 記事ID
- アクション（created/updated/deleted）
- 変更内容（JSON形式）
- 作成日時

**用途**:
- 記事の変更履歴を記録
- 誰がいつ何を変更したかを追跡
- 監査ログ

**例**:
```
記事を作成 → "created" アクションを記録
記事を編集 → "updated" アクションと変更内容を記録
記事を削除 → "deleted" アクションを記録
```

---

### 4. 設定管理（settings テーブル）

**保存するデータ**:
- 設定ID
- ユーザーID
- 設定キー（例: "OPENAI_API_KEY"）
- 設定値（暗号化）
- 作成日時、更新日時

**用途**:
- ユーザーごとの設定を保存
- APIキーなどの機密情報の保存（暗号化）
- カスタム設定の管理

**例**:
```
ユーザーが「設定ページでAPIキーを保存」→ settingsテーブルに保存
次回ログイン時に設定を読み込む
```

---

## データベースの必要性

### なぜデータベースが必要？

1. **データの永続化**
   - サーバーを再起動してもデータが残る
   - メモリではなく、ディスクに保存される

2. **複数ユーザーの管理**
   - 各ユーザーのデータを分離して管理
   - ユーザーごとに記事を表示

3. **データの整合性**
   - リレーション（関連）を保つ
   - 例: 記事を削除すると、関連する履歴も削除

4. **検索・フィルタリング**
   - ユーザーIDで記事を検索
   - ステータスで記事をフィルタリング

5. **履歴管理**
   - 過去の変更を追跡
   - データの復元が可能

---

## データベースの構造（テーブル間の関係）

```
users (ユーザー)
  ├── articles (記事) - 1ユーザーが複数の記事を持つ
  │     └── article_histories (記事履歴) - 1記事が複数の履歴を持つ
  └── settings (設定) - 1ユーザーが複数の設定を持つ
```

**例**:
- ユーザーAが記事1を作成 → `users.id` = A, `articles.user_id` = A
- 記事1を編集 → `article_histories.article_id` = 1

---

## Supabaseとの違い

### PostgreSQL（このアプリのデータベース）
- **用途**: アプリケーションのデータ（ユーザー、記事、設定）
- **管理**: アプリケーションが直接管理
- **場所**: ローカルまたはHeroku Postgres

### Supabase
- **用途**: 知識ベース（眼鏡生産者の想い）と画像データ
- **管理**: Supabaseが管理
- **場所**: Supabaseクラウド

**つまり**:
- PostgreSQL = アプリのデータ（ユーザー、記事など）
- Supabase = コンテンツデータ（知識、画像）

---

## データベースのセットアップ

### ローカルPostgreSQLを使用する場合

1. **PostgreSQLをインストール**
   ```bash
   # macOS
   brew install postgresql@15
   brew services start postgresql@15
   ```

2. **データベースを作成**
   ```bash
   createdb article_generator
   ```

3. **接続確認**
   ```bash
   psql -d article_generator -c "SELECT 1;"
   ```

4. **マイグレーション実行**
   ```bash
   cd backend
   alembic upgrade head
   ```
   これでテーブルが作成されます。

### テーブルが作成される内容

マイグレーションを実行すると、以下のテーブルが自動的に作成されます：

- `users` - ユーザーテーブル
- `articles` - 記事テーブル
- `article_histories` - 記事履歴テーブル
- `settings` - 設定テーブル

---

## まとめ

**データベース（PostgreSQL）は**:
- ✅ ユーザー情報を保存
- ✅ 生成された記事を保存
- ✅ 記事の履歴を記録
- ✅ ユーザー設定を保存

**データベースがないと**:
- ❌ ユーザー登録・ログインができない
- ❌ 生成した記事が保存されない（再生成が必要）
- ❌ 記事の履歴が残らない
- ❌ 設定が保存されない

つまり、**データベースはアプリケーションの核となるデータを保存するために必須**です。

