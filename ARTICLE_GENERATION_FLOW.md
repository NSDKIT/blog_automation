# 記事生成フロー詳細

## ユーザー入力変数

### 必須項目
- **キーワード**: メインキーワード（例: "ブルーライトカットメガネ"）
- **ターゲット層**: ターゲット読者（例: "20代女性"）
- **記事の種類**: 記事タイプ（例: "おすすめ記事"）

### 任意項目
- **使用シーン1-3**: 使用シーン（例: "リモートワーク"、"ゲーム"、"読書"）
- **システムプロンプト**: カスタムプロンプト
- **重要視したいキーワード1-3**: 重要キーワード（例: "PC作業"、"眼精疲労"、"軽量"）
- **SEO設定**（新規追加）:
  - 検索意図: 情報収集 / 購買検討 / 比較検討 / 問題解決
  - 検索地域: 日本 / 東京 / 大阪
  - デバイスタイプ: モバイル / デスクトップ
  - サブキーワード: カンマ区切り

---

## 処理フロー（詳細）

### ステップ0: リクエスト受信
```
ユーザーが「記事を生成」ボタンをクリック
↓
POST /api/articles にリクエスト送信
↓
バックエンドで記事レコードを作成（status: "processing"）
↓
バックグラウンドタスクを開始
```

### ステップ1: SEO分析（並列実行）

#### 1-1. SERP分析（DataForSEO SERP API）
```
入力: キーワード、検索地域、デバイスタイプ
↓
Google検索上位50件を取得
↓
取得データ:
  - タイトル、スニペット、URL
  - 見出し構造（H1, H2, H3）
  - People Also Ask（FAQ）
  - Related Searches
  - Featured Snippets
↓
分析処理:
  - 見出し構造の共通パターン抽出
  - キーワード出現頻度分析
  - コンテンツ長の平均値算出
  - FAQ項目の抽出
```

#### 1-2. キーワード調査（DataForSEO Keywords Data API）
```
入力: メインキーワード + 重要キーワード1-3 + サブキーワード
↓
各キーワードのデータを取得:
  - 検索ボリューム（月間検索数）
  - 競合度（キーワード難易度）
  - 関連キーワード（上位20件）
  - CPC（クリック単価）
  - トレンドデータ
```

#### 1-3. サブトピック生成（DataForSEO Content Generation API）
```
入力: メインキーワード
↓
関連サブトピックを10個生成
例: "ブルーライトカットメガネ" → 
  - ブルーライトとは
  - ブルーライトの影響
  - 選び方
  - おすすめブランド
  - 価格帯
  ...
```

### ステップ2: 知識ベース検索
```
入力: キーワード
↓
Supabaseのknowledge_baseテーブルから検索
↓
キーワードに関連する知識を取得（最大5件）
例: "眼鏡生産者の想い"、"職人技術"、"品質へのこだわり"
↓
取得した知識を結合してコンテキストとして使用
```

### ステップ3: Google検索（フォールバック）
```
※ SERP APIが使えない場合のみ実行
↓
Google Custom Search APIで上位10件を取得
↓
各URLからコンテンツを取得して分析
```

### ステップ4: 記事分析
```
SERP分析結果がある場合:
  - 見出し構造の共通パターンを使用
  - 平均タイトル長から最適文字数を算出
  - 頻出ワードを抽出

SERP分析結果がない場合:
  - Google検索結果をGeminiで分析
  - 最適文字数、頻出ワード、概要を抽出
```

### ステップ5: タイトル生成（GPT-4o）
```
プロンプトに含める情報:
  - 眼鏡生産者の想い（知識ベース）
  - Google検索結果の概要（記事分析）
  - ターゲット層
  - 記事の種類
  - 使用シーン1
  - 重要キーワード1-3
  - SERP分析結果（見出しパターン）
  - キーワードボリュームデータ

生成条件:
  - 文字数: 15-40文字
  - SERP分析結果の見出しパターンを参考
  - 高ボリュームキーワードを含める

出力: SEO最適化されたタイトル
例: "【2024年最新】ブルーライトカットメガネのおすすめ10選！PC作業に最適"
```

### ステップ6: 記事生成（Gemini 2.0 Flash）
```
プロンプトに含める情報:
  - 生成されたタイトル
  - 眼鏡生産者の想い（知識ベース）
  - 必須単語（メインキーワード）
  - 最適文字数（SERP分析から算出）
  - 見出しによく使われるワード
  - ターゲット読者
  - 重要キーワード1-3
  - サブトピックリスト
  - SERP分析結果（見出し構造）
  - FAQ項目（People Also Ask）

生成ルール:
  - 見出し構造をSERP分析結果に基づいて最適化
  - 高ボリュームキーワードを自然に組み込む
  - FAQセクションを自動生成
  - コンテンツ長を競合記事の平均値に合わせる

出力: Markdown形式の記事本文
```

### ステップ7: 画像選定
```
入力: キーワード
↓
Supabaseのuser_imagesテーブルから検索
↓
ユーザーIDとキーワードで一致する画像を取得（最大20件）
↓
画像データ:
  - image_url
  - alt_text
  - id
```

### ステップ8: 画像挿入（GPT-4o）
```
入力:
  - 記事本文
  - 画像データベース（URL、alt_text）
↓
GPT-4oが記事の適切な位置に画像を挿入
↓
Markdown形式で画像を挿入: ![alt](URL)
↓
出力: 画像が挿入された記事本文
```

### ステップ9: メタタグ生成（DataForSEO Content Generation API）
```
入力:
  - 生成されたタイトル
  - 画像挿入済み記事本文
↓
SEO最適化されたメタタグを生成:
  - メタタイトル（30-60文字）
  - メタディスクリプション（120-160文字）
↓
出力: meta_title, meta_description
```

### ステップ10: 構造化データ生成（Schema.org）
```
入力:
  - タイトル
  - 記事本文
  - FAQ項目（SERP分析から）
↓
以下の構造化データを生成:
  - Article Schema（記事情報）
  - FAQPage Schema（FAQセクション）
  - BreadcrumbList Schema（パンくず）
  - Organization Schema（組織情報）
↓
出力: JSON-LD形式の構造化データ
```

### ステップ11: Shopify形式変換（Gemini 2.0 Flash）
```
入力: 画像挿入済み記事本文
↓
GeminiがShopify JSON形式に変換
↓
出力: Shopify形式のJSON
{
  "article": {
    "title": "タイトル",
    "body_html": "<h2>見出し</h2><p>内容</p>",
    "metafields_global_description_tag": "meta_text",
    "status": "draft",
    "published": false,
    "tags": "Column",
    "author": "eightoon"
  }
}
```

### ステップ12: データベース保存
```
以下のデータをarticlesテーブルに保存:
  - title: 生成されたタイトル
  - content: 画像挿入済み記事本文（HTMLサニタイズ済み）
  - status: "completed"
  - shopify_json: Shopify形式のJSON
  - meta_title: SEO最適化メタタイトル
  - meta_description: SEO最適化メタディスクリプション
  - serp_data: SERP分析結果（JSONB）
  - serp_headings_analysis: 見出し構造分析（JSONB）
  - serp_common_patterns: 共通パターン（JSONB）
  - serp_faq_items: FAQ項目（JSONB）
  - keyword_volume_data: キーワードボリューム（JSONB）
  - related_keywords: 関連キーワード（JSONB）
  - keyword_difficulty: キーワード難易度（JSONB）
  - subtopics: サブトピックリスト（JSONB）
  - content_structure: コンテンツ構造（JSONB）
  - structured_data: 構造化データ（JSONB）
  - search_intent: 検索意図
  - target_location: 検索地域
  - device_type: デバイスタイプ
```

### ステップ13: 完了通知
```
statusを"completed"に更新
↓
フロントエンドが自動で記事詳細画面を更新
↓
ユーザーが生成された記事とSEO分析結果を確認可能
```

---

## 処理時間の目安

| ステップ | 処理時間 | 備考 |
|---------|---------|------|
| SERP分析 | 10-30秒 | DataForSEO API呼び出し |
| キーワード調査 | 5-15秒 | キーワード数による |
| サブトピック生成 | 3-5秒 | Content Generation API |
| 知識ベース検索 | 1-2秒 | Supabase検索 |
| タイトル生成 | 5-10秒 | GPT-4o API呼び出し |
| 記事生成 | 20-40秒 | Gemini 2.0 Flash |
| 画像選定 | 1-2秒 | Supabase検索 |
| 画像挿入 | 5-10秒 | GPT-4o API呼び出し |
| メタタグ生成 | 3-5秒 | Content Generation API |
| 構造化データ生成 | 1秒 | ローカル処理 |
| Shopify形式変換 | 5-10秒 | Gemini 2.0 Flash |
| **合計** | **約1-3分** | ネットワーク状況による |

---

## エラーハンドリング

### SEO分析が失敗した場合
- エラーログを出力
- **記事生成は続行**（SEO分析なしで生成）
- Google検索（フォールバック）を使用

### 画像が取得できない場合
- 画像なしで記事生成を続行
- 後で手動で画像を追加可能

### API呼び出しがタイムアウトした場合
- リトライは実装されていない（将来実装予定）
- エラーとして記録し、statusを"failed"に更新

---

## 生成されるデータの活用方法

### 記事詳細画面で確認できる情報

1. **メタタグ**
   - メタタイトル（文字数チェック付き）
   - メタディスクリプション（文字数チェック付き）

2. **キーワード情報**
   - 検索ボリューム
   - 競合度（0-100）
   - CPC（クリック単価）

3. **SERP分析結果**
   - 見出しパターンの統計（定義型、方法型、おすすめ型、比較型）
   - 各パターンの出現回数

4. **FAQ項目**
   - People Also Askから抽出された質問（上位5件）

5. **推奨サブトピック**
   - 記事に含めるべきトピック（10個）

---

## 次のステップ（ユーザー操作）

1. **記事の確認・編集**
   - タイトル・本文を編集可能
   - SEO分析結果を参考に改善

2. **Shopify/WordPressに投稿**
   - 「Shopifyに投稿」ボタンで投稿
   - 「WordPressに投稿」ボタンで投稿
   - メタタグと構造化データも自動で含まれる

3. **SEO分析結果の活用**
   - キーワード難易度を参考に戦略を調整
   - FAQ項目を記事に追加
   - サブトピックを記事に組み込む

